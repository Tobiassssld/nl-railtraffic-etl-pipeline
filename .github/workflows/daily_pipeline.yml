name: Daily NS Rail ETL Pipeline

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - '.github/workflows/**'

jobs:
  run-etl-pipeline:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install Microsoft ODBC Driver 18 for SQL Server
      run: |
        curl -sSL https://packages.microsoft.com/keys/microsoft.asc | sudo gpg --batch --yes --dearmor -o /usr/share/keyrings/microsoft-prod.gpg
        curl -sSL https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
        sudo apt-get update
        sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18 unixodbc-dev

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create data directories
      run: |
        mkdir -p data/raw
        mkdir -p data/processed
        mkdir -p logs
    
    - name: Get GitHub Runner public IP
      id: ip
      run: echo "runner_ip=$(curl -s https://api.ipify.org)" >> $GITHUB_OUTPUT
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Add temporary firewall rule for Runner IP
      run: |
        az sql server firewall-rule create \
          --resource-group rg-railtraffic \
          --server nl-rail-server-tobiasliu \
          --name "GitHubActions-${{ github.run_id }}" \
          --start-ip-address ${{ steps.ip.outputs.runner_ip }} \
          --end-ip-address ${{ steps.ip.outputs.runner_ip }}
        echo "Firewall rule created for IP: ${{ steps.ip.outputs.runner_ip }}"
        
        
    - name: Debug - Verify firewall and connectivity
      run: |
        echo "Runner IP: ${{ steps.ip.outputs.runner_ip }}"
        # 测试能否连通Azure SQL的1433端口
        nc -zv nl-rail-server-tobiasliu.database.windows.net 1433 || echo "Port 1433 not reachable"

        
    - name: Run ETL Pipeline
      env:
        NS_API_KEY: ${{ secrets.NS_API_KEY }}
        AZURE_SQL_CONNECTION_STRING: ${{ secrets.AZURE_SQL_CONNECTION_STRING }}
      run: |
        python src/pipeline.py
    
    - name: Remove temporary firewall rule
      if: always()
      run: |
        az sql server firewall-rule delete \
          --resource-group rg-railtraffic \
          --server nl-rail-server-tobiasliu \
          --name "GitHubActions-${{ github.run_id }}" || true
        echo "Firewall rule cleaned up"
    
    - name: Upload pipeline artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pipeline-outputs-${{ github.run_number }}
        path: |
          data/processed/*.csv
          logs/*.log
        retention-days: 7
    
    - name: Upload database
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: nl-rail-database-${{ github.run_number }}
        path: data/nl_rail.db
        retention-days: 30
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "Pipeline failed! Check the logs for details."